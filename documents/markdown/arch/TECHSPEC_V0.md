The Open Permissions Platform Key Technical Specification V0
================================================

- DEPRECATION NOTICE -
======================
This specification is to be deprecated, please see the V1 specification.

Table of Contents
=================

* [Introduction](#user-content-introduction)
* [Hub Key description](#user-content-hub-key-description)
  * [Examples](#user-content-examples)
* [Unicode](#user-content-unicode)
* [General note on Hub Key composition and decomposition](#user-content-general-note-on-hub-key-composition-and-decomposition)
* [Requirements](#user-content-requirements)
* [Common referent types](#user-content-currently-supported-referent-types)
  * [Entity](#user-content-entity)
  * [Asset](#user-content-asset)
  * [Party](#user-content-party)
  * [Offer](#user-content-offer)
* [Predefined ID types](#user-content-predefined-id-types)
* [Example of ID types](#user-content-example-of-id-types)
* [Hub Key metadata fields](#user-content-hub-key-metadata-fields)

# Introduction

The Hub Key is a unique identifier generated by the Open Permissions Platform to identify an asset. The Hub Key is generated during the onboarding process. A unique Hub Key is returned by the Onboarding API for each successfully onboarded asset. Thereafter it can be used as a key to retrieve license data from Open Permissions Platform repositories.

Typically the Hub Key is written into the asset metadata after the asset is onboarded, providing a direct link from the asset to the license offers data held about it in Open Permissions Platform repositories. See [Hub Key metadata fields](#user-content-hub-key-metadata-fields) for a table showing which metatata fields should be used to store a Hub Key, depending on asset type.

The Hub Key takes the form of a valid URL conforming to [RFC3986 section 3.3](http://tools.ietf.org/html/rfc3986#section-3.3), composed from specified elements. Like a URL, it can be decomposed into path segments.

The remainder of this document is a specification of how the Hub Key is composed. Decomposing a Hub Key is the reverse of composing a Hub Key.

# Hub Key description

The Hub Key is composed from the following elements. Note that each segment **must** be valid as a URL path segment, as described below:

|Field|Description|Example|
|:---|:---|:---|
|**separator**|Use `/` as per specification below|`/`|
|**schema_version**|The version of the schema (this specification) that defines the key format|`s0`|
|**resolver_id**|The name of the host that can resolve the Hub Key. Must be a valid hostname|`copyrighthub.org`|
|**hub_id**|The id of the hub that is requesting the key|`hub1`|
|**referent_type**|The type of a object to which the requested key refers. Hub Keys are used to uniquely identify various types of object that may be referenced in rights data| This is generally defined by the ontology supporting the hub. `asset`, `offer`, `party`, or other type of referent, see [Currently supported referent types](#user-content-currently-supported-referent-types)|
|**provider_id**|ID of an organisation that is registered as a provider with the Open Permissions Platform and specifically is registered with the hub that is requesting the key. Typically identifies the organisation that requested this Hub Key to be generated. For example when the `referent_type` is `asset` the `provider_id` identifies the organisation that onboarded the asset. When the `referent_type` is `party` the `provider_id` identifies the organisation that assigned the party ID|For example, a picture library named My Picture Library might have the registered provider ID `prov0001`. The Open Permissions Platform provider ID is `chub`|
|**id_type**|The type of an existing identifier that identifies the referent. For example if the `referent_type` is `asset` the `id_type` may be a standards-based schema such as ISBN. For other referent types the `id_type` may be a PID (Open Permissions Platform Provider ID), a UUID, or an arbitrary string assigned by the provider identified by the `provider_id`|`doi`, `isbn`, `isan` or other standard type including `hubkey`; `pid` assigned by the Open Permissions Platform, or an identifier assigned by the provider; or `uuid` if no more specific type is defined. See [Example of ID types](#user-content-example-of-id-types)|
|**id**|The value of the identifier of specified type, for example if `id_type` is `isbn` then this is a valid ISBN.|A valid value for an identifier of specified type. May iteslf be a Hub Key|

A valid URL path segment consists of alpha numeric characters, the special characters `.-_~!$&'()*+,;=:@'`, or a percent encoded character. See [RFC3986 section 3.3](http://tools.ietf.org/html/rfc3986#section-3.3).

The Hub Key URI is composed as follows:

```
<schema_version><separator><hub_id><separator><referent_type><separator><provider_id><separator><id_type><separator><id>
```

The Hub Key resolvable URL is composed from the Hub Key URI, with protocol and resolving host specified:

```
https://<resolver_id><separator><schema_version><separator><hub_id><separator><referent_type><separator><provider_id><separator><id_type><separator><id>
```

For `schema_version` `s0`, the URL should match this regular expression:

```
^https:\/\/((?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])(?:\.(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9]))*(?::[0-9]{2,5})?)\/(s0)\/((?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)\/((?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)\/((?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)\/((?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)\/((?:(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+|https:\/\/(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])(?:\.(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9]))*(?::[0-9]{2,5})?\/s0\/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+\/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+\/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+\/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+\/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+))$
```

The following Python-specific regular expression using named groups is the actual matching code used in the Open Permissions Platform system library:

```
^https://(?P<resolver_id>(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])(?:\.(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9]))*(?::[0-9]{2,5})?)/(?P<schema_version>s0)/(?P<hub_id>(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)/(?P<referent_type>(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)/(?P<provider_id>(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)/(?P<id_type>(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+)/(?P<id>(?:(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+|https://(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])(?:\.(?:[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9]))*(?::[0-9]{2,5})?/s0/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+/(?:[a-zA-Z0-9\.\-_~!$&'()*+,;=:@]|%[\da-fA-F]{2})+))$
```

## Examples

With these values:
* separator = `/`
* resolver_id = `copyrighthub.org`
* schema_version = `s0`
* hub_id = `hub1`
* referent_type = `asset`
* provider_id = `maryevans`
* id_type = `maryevanspictureid`
* id = `10413373`

the following Hub Key resolvable URL is generated (shown non-URL encoded) identifying an asset that was onboarded through `hub1` to `copyrighthub.org`:
* https://copyrighthub.org/s0/hub1/asset/maryevans/maryevanspictureid/10413373

Note that this is a valid URL which resolves to photographic image licensing data held by the Open Permissions Platform. For example, the URL can be pasted directly into a browser and navigated to.

Similarly, the following Hub Keys identify parties registered with the Open Permissions Platform, in the first case the Mary Evans Picture Library, and in the second case a Quora service member known to Quora via a Facebook user ID:

* https://copyrighthub.org/s0/hub1/party/chub/pid/maryevans
* https://copyrighthub.org/s0/hub1/party/quora/facebookid/fb123456

**TBD** Should these also be directly resolvable i.e. in the browser nav bar?

# Unicode

The Hub Key **must not** contain Unicode characters, to ensure that it can be used as a valid URI.

Instead, when a Hub Key is generated the `resolver_id` is encoded using the Internationalized Domain Names in Applications (IDNA) ptotocol, see [RFC5891](https://www.ietf.org/rfc/rfc5891.txt). The remaining components are percent encoded, see [RFC3987](https://www.ietf.org/rfc/rfc3987.txt) and [RFC3490](https://www.ietf.org/rfc/rfc3490.txt).

# General note on Hub Key composition and decomposition

Hubkeys are designed as identifiers which have to be unique, well-formed and non-intelligent. However, Hub Keys as described in this document are deliberately designed with sufficient "intelligence" so as to be easily composed from an existing ID used in a repository, and to be readily decomposed to recover the ID from which they are composed.

This design reduces the overheads for repository engagement, because it means that repository administrators can easily and reversibly translate IDs used in existing databases into Hub Keys, allowing them to retain existing IDs while interoperating with Open Permissions Platform services.

To enable translation, the **id_type** and **id** of an existing repository ID
must be included in the Hub Key, as shown in the asset Hub Key example above. It is the responsibility of the repository, not the Open Permissions Platform services, to map generated Hub Keys to the entity records in an existing database.

Also note that as per linked data requirements the default identifier is the full Hub Key resolvable URL. The Hub Key URI is provided for circumstances where alternative means of resolution are required for availablity or feature reasons.

# Requirements

| Requirement | Reason |
|:---|:---|
|The **schema_version** must be updated if there is a change to the structure of the Hub Key which affects the way it can be decomposed|Ensure reliable and future proof decomposition|
|The **resolver_id** that the object belongs to must be extractable from the Hub Key|Prevent recursive Hub Keys being created within each other|
|Each hub will have a unique **hub_id**|Support federated and unique IDs for a world of many hubs|
|The **provider_id** must be unique to the hub the provider is registered to|Support federated and unique Hub Keys within hubs|
|A provider can have more than 1 **provider_id** but by default has 1|A provider may offer services to other providers not known to the hub|
|A provider must guarantee for its assigned **provider_id**, **resolver_id**, **hub_id**, **referent_type**, that any IDs used are unique|Maintain uniqueness of Hub Keys without duplicates|
|The **referent_type** must be extractable from the Hub Key. For supported referent types, see [Currently supported referent types](#user-content-currently-supported-referent-types)|Support the case where repositories have well formed identifiers for Assets but not for other referent types for which different methods of generating Hub Keys are used|
|A referent can have more than one recognisable ID outside of the hub|Some assets may have a standard recognised ID along with an ID that the provider uses|
|If no **id** is specified when requesting a Hub Key from a key generating service, then a unique ID will be generated|Guarantee Hub Key uniqueness|

# Currently supported referent types

The Hub Keys can be generated for any type referred in the ontology. The referrent type is generally the **qname** of an OWL
class in the ontology underlying the hub.  It is assumed that there is no conflict of qname in the types

* **entity**
* **asset**
* **party**
* **offer*

## Entity
Every `referent` is by default **entity** unless a more specific referent type can be applied.

All of the above are identified as being of type `entity` and have an identifier of type `uuid`:
* `referent_type` = `entity`
* `provider_id` = Varies
* `id_type` = `uuid`
* `id` = A valid UUID, [see predefined id types](#user-content-predefined-id-types)

## Asset
A work or other digitally copyable artifact for which a license offer has been onboarded by the system.

An **asset** has an asset ID with an `id_type` of a supported standard or proprietary type that identifies it as an asset, or else of type `uuid`. Standard types include `doi` and `isbn`, see the table in [Example of ID types](#user-content-example-of-id-types). Proprietary types are types that have been assigned by Open Permissions Platform admins to asset IDs originating from specific organisations. For example, the Mary Evans Picture Library onboards images with asset IDs of `id_type` `maryevanspictureid`.

Typically the asset ID is supplied with the asset by the party that onboards it.

When a asset is onboarded **without** a supplied asset ID the system assigns one of `id_type` `uuid`. Open Permissions Platform generated UUIDs conform to RFC4122.

There is currently no mechanism for the onboarding organisation to **declare** proprietary asset ID types. They must be agreed with and manually registered by the Open Permissions Platform.

* `referent_type` = `asset`
* `provider_id` = The party that onboards the asset
* `id_type` = standard types including `doi` and `isbn`, proprietary types for example `MaryEvansPictureLibrary`, or default `uuid`
* `id` = A valid identifier of the specified type, see [Example of ID types](#user-content-example-of-id-types)

Hub Key examples (**Asset** ID `id_type` and `id` in bold):

* `https://copyrighthub.org/s0/hub1/asset/maryevans/`**maryevanspictureid/10413373**
* `https://copyrighthub.org/s0/hub1/asset/quora/`**quorapictureid/quo987654321**

## Party
An individual or organisation associated with a asset or with license policies relating to a party.

A **party** has a party ID with an `id_type` that identifies it as a party.

Two kinds of party IDs are supported:

1. IDs assigned by the Open Permissions Platform to registered parties of `id_type` `pid`, short for Open Permissions Platform Party ID. The Open Permissions Platform admins assign a unique `pid` to all registered organisations, typically a meaningful short string. For example `chub` is the `pid` of the Open Permissions Platform itself. A special "don't care" `pid` of `anyone` is used for non-registered individuals or organisations. Note that this adds a restriction that an organisation registered in the accounts service **must not** be assigned a `pid` with the value `anyone`.
2. IDs assigned by registered parties of the Open Permissions Platform to their own users who are not registered with the Open Permissions Platform, for example individual photographers or other members of the general public who may need to be referred to in a Hub Key e.g. as a party to whom a license offer has been assigned. In this case the `id_type` is assigned by the provider, who is identified by `provider_id`. A typical example is a service that allows users to register with a Facebook, Google, or Pinterest username. The `id_type` is assigned by the provider to identify the type of the username, for example `facebookID`.

* `referent_type` = `party`
* `provider_id` = The party that assigns the `party_id`
* `id_type` = Open Permissions Platform assigned type `pid` or `anyone`, various third-party service assigned types for example `facebookID`
* `id` = A valid identifier of the specified type, see [Example of ID types](#user-content-example-of-id-types)

Hub Key examples (**Party** ID `id_type` and `id` in bold):

`https://copyrighthub.org/s0/hub1/party/chub/`**pid/maryevans**
`https://copyrighthub.org/s0/hub1/party/quora/`**facebookid/fb123456**

## Offer
A license offer that can be associated with assets. For example, a license offer to use an asset under agreed conditions in a specific geography.

* `referent_type` = `offer`
* `provider_id` = The party that provide the license offer
* `id_type` = `uuid`
* `id` = A valid UUID, [see predefined id types](#user-content-predefined-id-types)

Hub Key examples (**Offer** ID `id_type` and `id` in bold):

`https://copyrighthub.org/s0/hub1/offer/quora/`**uuid/123456**
`https://copyrighthub.org/s0/hub1/offer/maryevans/`**uuid/a12235**

# Predefined ID types
The system has some predefined ID types. With these id types the following restrictions apply:

|Type|Description|
|:---|:----------|
|**uuid**|The **id** must be a universally unique identifier. See [RFC4122](https://www.ietf.org/rfc/rfc4122.txt)|
|**pid** |Party identifier. The **id** must be either **anyone** or the assigned ID of an organisation registered with the Open Permissions Platform|

# Example of ID types

|Type|Description|Web site|
|:---|:----------|:-------|
|**DOI** |Digital Object Identifier                |http://www.doi.org/  |
|**ISAN**|International Standard Audiovisual Number|http://www.isan.org/ |
|**ISBN**|International Standard Book Number       |http://www.isbn.org/ |
|**ISRC**|International Standard Recording Code    |http://isrc.ifpi.org/|

A provider may also have, and use, its own proprietary ID types, but note the
warning against using URL specific characters such as `?`, `/`, `#` or `:`
within the ID.

# Hub Key metadata fields

Note that currently a recommended Hub Key field has been defined only for photographic image metadata.

|Asset type|Metadata standard|Hub Key field name|
|---|---|---|
|Photographic images|http://www.iptc.org/std/photometadata/specification/IPTC-PhotoMetadata |IPTC Core Rights: Usage Terms|

**TBD:** Include an example of the XML?

<!-- Copyright Notice -->
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
